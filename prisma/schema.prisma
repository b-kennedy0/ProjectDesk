datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           Int     @id @default(autoincrement())
  name         String?
  email        String  @unique
  role         String  @default("student") // 'supervisor' | 'student' | 'collaborator' | 'admin'
  supervisorId Int?
  passwordHash String? // used only for local Credentials auth (nullable for SSO users)

  projects              Project[]       @relation("ProjectSupervisor")
  memberships           ProjectMember[]
  comments              Comment[]
  sentNotifications     Notification[]  @relation("ActorNotifications")
  receivedNotifications Notification[]  @relation("RecipientNotifications")
}

model Project {
  id            Int             @id @default(autoincrement())
  title         String
  description   String?
  supervisorId  Int
  supervisor    User            @relation("ProjectSupervisor", fields: [supervisorId], references: [id])
  members       ProjectMember[]
  tasks         Task[]
  startDate     DateTime?
  endDate       DateTime?
  createdAt     DateTime        @default(now())
  notifications Notification[]
}

model ProjectMember {
  id        Int     @id @default(autoincrement())
  project   Project @relation(fields: [projectId], references: [id])
  projectId Int
  user      User    @relation(fields: [userId], references: [id])
  userId    Int
  role      String // 'student' | 'collaborator'
}

model Task {
  id               Int            @id @default(autoincrement())
  project          Project        @relation(fields: [projectId], references: [id])
  projectId        Int
  title            String
  description      String?
  status           String         @default("todo") // 'todo' | 'in_progress' | 'done'
  dueDate          DateTime?
  dependencyTaskId Int?
  flagged          Boolean        @default(false)
  comments         Comment[]
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  notifications    Notification[]

  @@index([projectId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  task      Task     @relation(fields: [taskId], references: [id])
  taskId    Int
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  text      String
  createdAt DateTime @default(now())
}

model Notification {
  id        Int     @id @default(autoincrement())
  project   Project @relation(fields: [projectId], references: [id])
  projectId Int
  task      Task?   @relation(fields: [taskId], references: [id])
  taskId    Int?

  actor       User @relation("ActorNotifications", fields: [actorId], references: [id])
  actorId     Int
  recipient   User @relation("RecipientNotifications", fields: [recipientId], references: [id])
  recipientId Int

  type      String // 'task_flagged' | 'task_commented'
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([recipientId, read])
  @@index([projectId])
}
